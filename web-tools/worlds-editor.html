<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Миры • tw_worlds</title>

  <link rel="stylesheet" href="editor-core/editor-theme.css" />
  <link rel="stylesheet" href="editor-core/editor-template.css" />

  <!-- Fonts + icons -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

  <script src="editor-core/tailwind-theme.js"></script>
  <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
</head>

<body class="editor-theme" data-editor="worlds">
  <div class="editor-page">
    <div class="editor-page-header">
      <div class="editor-page-title">
        <i class="fa-solid fa-globe text-accent text-xl"></i>
        <div>
          <h1>Миры</h1>
          <div class="editor-page-sub">Редактор таблицы <code>tw_worlds</code></div>
        </div>
      </div>
      <div class="editor-page-actions">
        <button class="editor-btn editor-btn-secondary" data-editor-role="refresh">
          <i class="fa-solid fa-rotate"></i><span>Обновить</span>
        </button>
        <button class="editor-btn editor-btn-primary" data-editor-role="new">
          <i class="fa-solid fa-plus"></i><span>Новый мир</span>
        </button>
      </div>
    </div>

    <div class="editor-shell editor-shell--docked">
      <!-- Sidebar -->
      <aside class="editor-sidebar editor-dock-sidebar">
        <div class="editor-dock-pad">
          <div class="flex items-center justify-between gap-3">
            <div>
              <div class="text-sm font-semibold">Список миров</div>
              <div class="text-xs editor-muted-text">Всего: <span data-editor-role="count">—</span></div>
            </div>
          </div>

          <div class="mt-3">
            <div class="editor-search">
              <i class="fa-solid fa-magnifying-glass"></i>
              <input data-editor-role="search" type="search" class="w-full editor-input form-input" placeholder="Поиск по ID/названию/пути…" />
            </div>
          </div>

          <div class="mt-3 editor-sidebar-filters">
            <select id="filterType" class="w-full editor-input form-input">
              <option value="">Все типы</option>
            </select>
          </div>

          <div class="mt-4 editor-sidebar-list editor-scroll" style="max-height: 590px" data-editor-role="list"></div>
        </div>
      </aside>

      <!-- Main -->
      <section class="editor-main editor-dock-main">
        <div class="editor-dock-pad">
          <div class="editor-sticky-toolbar flex items-start justify-between gap-4">
            <div>
              <div class="text-lg font-semibold" data-editor-role="title">Выберите мир</div>
              <div class="editor-muted-text text-sm mt-1" data-editor-role="subtitle">или создайте новый</div>
            </div>
            <div class="editor-page-actions">
              <span id="dirty-pill" class="editor-dirty-pill hidden">Данные не сохранены</span>
              <button class="editor-btn editor-btn-primary" data-editor-role="save" disabled>
                <i class="fa-solid fa-floppy-disk"></i><span>Сохранить</span>
              </button>
              <button class="editor-btn editor-btn-secondary" data-editor-role="delete" disabled>
                <i class="fa-solid fa-trash"></i><span>Удалить</span>
              </button>
            </div>
          </div>

          <div class="editor-section mt-4">
            <div class="editor-form-grid-2" data-editor-role="form"></div>
          </div>

          <div class="mt-4" data-editor-role="status"></div>
        </div>
      </section>
    </div>
  </div>

  <script src="editor-core/editor-core.bundle.js"></script>
  <script src="editor-core/db-editor-runtime.js"></script>
  <script>
    const { fieldRenderOptions } = EditorCore.bootstrapEditor({ mode: 'event' });

    const FLAGS = [
      'rating_system',
      'crime_score',
      'lost_gold_death',
      'spawn_full_mana',
      'allowed_pvp',
    ];

    const parseFlags = (value) => {
      if (!value) return [];
      if (Array.isArray(value)) return value.map(v => String(v).trim()).filter(Boolean);
      return String(value)
        .split(',')
        .map(v => v.trim())
        .filter(Boolean);
    };

    const serializeFlags = (value) => {
      const list = Array.isArray(value) ? value.map(v => String(v).trim()).filter(Boolean) : [];
      return list.length ? list.join(',') : null;
    };

    const TYPES = [
      'default',
      'dungeon',
      'tutorial',
      'deep_dungeon',
      'treasure_dungeon',
      'pvp',
      'mini_games',
    ];

    const worldFields = {
      Name: { type: 'text', label: 'Название', validate: { required: true }, ui: { placeholder: 'Например: Gridania' } },
      Path: { type: 'text', label: 'Путь карты', validate: { required: true }, ui: { placeholder: 'main.map' } },
      Type: {
        label: 'Тип мира',
        ui: {
          type: 'select',
          options: TYPES.map((type) => ({ value: type, label: type }))
        }
      },
      Flags: {
        label: 'Флаги',
        ui: {
          type: 'tags',
          options: FLAGS,
          placeholder: 'Добавить флаг…'
        }
      },
      RespawnWorldID: { type: 'db_select', label: 'Мир респавна', ui: { dbKey: 'world', placeholder: '— мир —', searchPlaceholder: 'Поиск мира…' } },
      JailWorldID: { type: 'db_select', label: 'Мир тюрьмы', ui: { dbKey: 'world', placeholder: '— мир —', searchPlaceholder: 'Поиск мира…' } },
      RequiredLevel: { type: 'number', label: 'Минимальный уровень', ui: { min: 1, step: 1 } },
    };

    const dirty = EditorCore.Dirty?.create
      ? EditorCore.Dirty.create({
          root: document.querySelector('.editor-main') || document.body,
          pill: document.getElementById('dirty-pill'),
          beforeUnload: true,
        })
      : { markDirty: () => {}, setClean: () => {} };

    const filterType = document.getElementById('filterType');
    if (filterType) {
      filterType.innerHTML = [
        '<option value=\"\">Все типы</option>',
        ...TYPES.map(type => `<option value=\"${type}\">${type}</option>`),
      ].join('');
    }

    const editor = EditorCore.DbEditor.mount(document.body, {
      resource: 'worlds',
      fields: worldFields,
      fieldOptions: fieldRenderOptions,
      dirty,
      transformList: (rows) => {
        const type = filterType?.value || '';
        return type ? rows.filter(row => String(row?.Type || '') === type) : rows;
      },
      defaults: () => ({
        Name: '',
        Path: '',
        Type: 'default',
        Flags: [],
        RespawnWorldID: 0,
        JailWorldID: 0,
        RequiredLevel: 1,
      }),
      rowToModel: (row) => ({
        Name: String(row?.Name || ''),
        Path: String(row?.Path || ''),
        Type: String(row?.Type || 'default'),
        Flags: parseFlags(row?.Flags),
        RespawnWorldID: Number(row?.RespawnWorldID || 0),
        JailWorldID: Number(row?.JailWorldID || 0),
        RequiredLevel: Number(row?.RequiredLevel || 1),
      }),
      modelToPayload: (model) => ({
        Name: String(model?.Name || ''),
        Path: String(model?.Path || ''),
        Type: String(model?.Type || 'default'),
        Flags: serializeFlags(model?.Flags),
        RespawnWorldID: Number(model?.RespawnWorldID || 0),
        JailWorldID: Number(model?.JailWorldID || 0),
        RequiredLevel: Math.max(1, Number(model?.RequiredLevel || 1)),
      }),
      listItem: (row) => ({
        title: row?.Name || `Мир #${row?.ID || 0}`,
        subtitle: `${row?.Path || '—'} · ID ${row?.ID ?? '—'}`
      }),
      getTitle: (model, id) => (id ? `Мир: ${model?.Name || `#${id}`}` : 'Новый мир'),
      getSubtitle: (model, id) => {
        if (!model) return '';
        const type = model.Type ? `Тип: ${model.Type}` : 'Тип: —';
        const path = model.Path ? `Путь: ${model.Path}` : 'Путь: —';
        return id ? `ID ${id} · ${type} · ${path}` : `${type} · ${path}`;
      },
      emptyTitle: 'Выберите мир',
      emptySubtitle: 'или создайте новый',
    });

    filterType?.addEventListener('change', () => {
      editor.refresh();
    });
  </script>
</body>
</html>
